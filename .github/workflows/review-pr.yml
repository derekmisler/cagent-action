# Reusable workflow for AI-powered PR reviews
#
# Usage:
#   name: PR Review
#   on:
#     issue_comment: # Enables /review command in PR comments
#       types: [created]
#     pull_request_review_comment: # Captures feedback on review comments for learning
#       types: [created]
#     pull_request_target: # Triggers auto-review on PR open; uses base branch context so secrets work with forks
#       types: [ready_for_review, opened]
#
#   jobs:
#     review:
#       uses: docker/cagent-action/.github/workflows/review-pr.yml@latest
#       # Scoped to the job so other jobs in this workflow aren't over-permissioned
#       permissions:
#         contents: read       # Read repository files and PR diffs
#         pull-requests: write # Post review comments and approve/request changes
#         issues: write        # Create security incident issues if secrets are detected in output
#       secrets:
#         ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
#         CAGENT_ORG_MEMBERSHIP_TOKEN: ${{ secrets.CAGENT_ORG_MEMBERSHIP_TOKEN }} # PAT with read:org scope; gates auto-reviews to org members only
#         CAGENT_REVIEWER_APP_ID: ${{ secrets.CAGENT_REVIEWER_APP_ID }} # GitHub App ID; reviews appear as your app instead of github-actions[bot]
#         CAGENT_REVIEWER_APP_PRIVATE_KEY: ${{ secrets.CAGENT_REVIEWER_APP_PRIVATE_KEY }} # GitHub App private key; paired with App ID above

name: PR Review

on:
  workflow_call:
    inputs:
      pr-number:
        description: "Pull request number (auto-detected if not provided)"
        required: false
        type: string
        default: ""
      comment-id:
        description: "Comment ID for reactions (auto-detected if not provided)"
        required: false
        type: string
        default: ""
      additional-prompt:
        description: "Additional instructions for the review"
        required: false
        type: string
        default: ""
      model:
        description: "Model to use (e.g., anthropic/claude-sonnet-4-5)"
        required: false
        type: string
        default: ""
      cagent-version:
        description: "Version of cagent to use"
        required: false
        type: string
        default: "v1.24.0"
      add-prompt-files:
        description: "Comma-separated list of files to append to the prompt (e.g., 'AGENTS.md,CLAUDE.md')"
        required: false
        type: string
        default: ""
      auto-review-org:
        description: "Organization to check membership for auto-reviews"
        required: false
        type: string
        default: "docker"
    secrets:
      CAGENT_ORG_MEMBERSHIP_TOKEN:
        description: "PAT with read:org scope to check org membership for auto-reviews"
        required: false
      ANTHROPIC_API_KEY:
        description: "Anthropic API key (at least one API key required)"
        required: false
      OPENAI_API_KEY:
        description: "OpenAI API key (at least one API key required)"
        required: false
      GOOGLE_API_KEY:
        description: "Google API key (at least one API key required)"
        required: false
      AWS_BEARER_TOKEN_BEDROCK:
        description: "AWS Bearer token for Bedrock (at least one API key required)"
        required: false
      XAI_API_KEY:
        description: "xAI API key for Grok (at least one API key required)"
        required: false
      NEBIUS_API_KEY:
        description: "Nebius API key (at least one API key required)"
        required: false
      MISTRAL_API_KEY:
        description: "Mistral API key (at least one API key required)"
        required: false
      CAGENT_REVIEWER_APP_ID:
        description: "GitHub App ID for reviewer identity"
        required: false
      CAGENT_REVIEWER_APP_PRIVATE_KEY:
        description: "GitHub App private key"
        required: false
    outputs:
      exit-code:
        description: "Exit code from the review"
        value: ${{ jobs.auto-review.outputs.exit-code || jobs.manual-review.outputs.exit-code }}

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ==========================================================================
  # AUTOMATIC REVIEW FOR ORG MEMBERS
  # Triggers when a PR is marked ready for review or opened (non-draft)
  # Only runs for members of the configured org (supports fork-based workflow)
  # ==========================================================================
  auto-review:
    if: |
      github.event_name == 'pull_request_target' &&
      !github.event.pull_request.draft
    runs-on: ubuntu-latest
    env:
      HAS_APP_SECRETS: ${{ secrets.CAGENT_REVIEWER_APP_ID != '' }}
    outputs:
      exit-code: ${{ steps.run-review.outputs.exit-code }}

    steps:
      - name: Check if PR author is org member
        id: membership
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.CAGENT_ORG_MEMBERSHIP_TOKEN }}
          script: |
            const org = '${{ inputs.auto-review-org }}';
            const username = context.payload.pull_request.user.login;

            try {
              await github.rest.orgs.checkMembershipForUser({
                org: org,
                username: username
              });
              core.setOutput('is_member', 'true');
              console.log(`âœ… ${username} is a ${org} org member - proceeding with auto-review`);
            } catch (error) {
              if (error.status === 404 || error.status === 302) {
                core.setOutput('is_member', 'false');
                console.log(`â­ï¸ ${username} is not a ${org} org member - skipping auto-review`);
              } else if (error.status === 401) {
                core.setFailed(
                  'âŒ CAGENT_ORG_MEMBERSHIP_TOKEN secret is missing or invalid.\n\n' +
                  `This secret is required to check ${org} org membership for auto-reviews.\n\n` +
                  'To fix this:\n' +
                  '1. Create a classic PAT with read:org scope at https://github.com/settings/tokens/new\n' +
                  '2. Add it as an org secret named CAGENT_ORG_MEMBERSHIP_TOKEN'
                );
              } else {
                core.setFailed(`Failed to check org membership: ${error.message}`);
              }
            }

      # Safe to checkout PR head because review-pr only READS files (no code execution)
      - name: Checkout PR head
        if: steps.membership.outputs.is_member == 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          ref: refs/pull/${{ github.event.pull_request.number }}/head

      # Generate GitHub App token for custom app identity (optional - falls back to github.token)
      - name: Generate GitHub App token
        if: steps.membership.outputs.is_member == 'true' && env.HAS_APP_SECRETS == 'true'
        id: app-token
        continue-on-error: true # Don't fail workflow if token generation fails
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2
        with:
          app_id: ${{ secrets.CAGENT_REVIEWER_APP_ID }}
          private_key: ${{ secrets.CAGENT_REVIEWER_APP_PRIVATE_KEY }}

      - name: Run PR Review
        if: steps.membership.outputs.is_member == 'true'
        id: run-review
        uses: docker/cagent-action/review-pr@latest
        with:
          pr-number: ${{ inputs.pr-number || github.event.pull_request.number }}
          additional-prompt: ${{ inputs.additional-prompt }}
          add-prompt-files: ${{ inputs.add-prompt-files }}
          model: ${{ inputs.model }}
          cagent-version: ${{ inputs.cagent-version }}
          github-token: ${{ steps.app-token.outputs.token || github.token }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          google-api-key: ${{ secrets.GOOGLE_API_KEY }}
          aws-bearer-token-bedrock: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
          xai-api-key: ${{ secrets.XAI_API_KEY }}
          nebius-api-key: ${{ secrets.NEBIUS_API_KEY }}
          mistral-api-key: ${{ secrets.MISTRAL_API_KEY }}

  # ==========================================================================
  # MANUAL REVIEW PIPELINE
  # Triggers when someone comments /review on a PR
  # ==========================================================================
  manual-review:
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/review')
    runs-on: ubuntu-latest
    env:
      HAS_APP_SECRETS: ${{ secrets.CAGENT_REVIEWER_APP_ID != '' }}
    outputs:
      exit-code: ${{ steps.run-review.outputs.exit-code }}

    steps:
      # Checkout PR head (not default branch)
      # Note: Authorization is handled by the composite action's built-in check
      - name: Checkout PR head
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          ref: refs/pull/${{ github.event.issue.number }}/head

      # Generate GitHub App token for custom app identity (optional - falls back to github.token)
      - name: Generate GitHub App token
        if: env.HAS_APP_SECRETS == 'true'
        id: app-token
        continue-on-error: true # Don't fail workflow if token generation fails
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2
        with:
          app_id: ${{ secrets.CAGENT_REVIEWER_APP_ID }}
          private_key: ${{ secrets.CAGENT_REVIEWER_APP_PRIVATE_KEY }}

      - name: Run PR Review
        id: run-review
        uses: docker/cagent-action/review-pr@latest
        with:
          pr-number: ${{ inputs.pr-number || github.event.issue.number }}
          comment-id: ${{ inputs.comment-id || github.event.comment.id }}
          additional-prompt: ${{ inputs.additional-prompt }}
          add-prompt-files: ${{ inputs.add-prompt-files }}
          model: ${{ inputs.model }}
          cagent-version: ${{ inputs.cagent-version }}
          github-token: ${{ steps.app-token.outputs.token || github.token }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          google-api-key: ${{ secrets.GOOGLE_API_KEY }}
          aws-bearer-token-bedrock: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
          xai-api-key: ${{ secrets.XAI_API_KEY }}
          nebius-api-key: ${{ secrets.NEBIUS_API_KEY }}
          mistral-api-key: ${{ secrets.MISTRAL_API_KEY }}

  # ==========================================================================
  # CAPTURE FEEDBACK
  # Saves feedback data as an artifact for lazy processing. This job
  # intentionally avoids using secrets so it works for fork PRs in public
  # repos. The actual AI processing happens during the next review run,
  # which has full secret access via pull_request_target or issue_comment.
  # ==========================================================================
  capture-feedback:
    if: github.event_name == 'pull_request_review_comment' && github.event.comment.in_reply_to_id
    runs-on: ubuntu-latest

    steps:
      - name: Check if reply is to agent comment
        id: check
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          PARENT_ID: ${{ github.event.comment.in_reply_to_id }}
        run: |
          if [ -z "$PARENT_ID" ]; then
            echo "is_agent=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Not a reply comment, skipping"
            exit 0
          fi

          parent=$(gh api repos/${{ github.repository }}/pulls/comments/$PARENT_ID 2>/dev/null || echo "{}")
          if echo "$parent" | jq -r '.body // ""' | grep -q "<!-- cagent-review -->"; then
            echo "is_agent=true" >> $GITHUB_OUTPUT
            echo "âœ… Reply is to an agent review comment"
          else
            echo "is_agent=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Not a reply to agent comment, skipping"
          fi

      - name: Save feedback data
        if: steps.check.outputs.is_agent == 'true'
        shell: bash
        env:
          COMMENT_JSON: ${{ toJSON(github.event.comment) }}
        run: |
          mkdir -p feedback
          echo "$COMMENT_JSON" > feedback/feedback.json
          echo "ðŸ“¦ Saved feedback data for async processing"

      - name: Upload feedback artifact
        if: steps.check.outputs.is_agent == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: pr-review-feedback
          path: feedback/
          retention-days: 90
